<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guess the Flag — Layer Reveal</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif }
    body { margin: 0; display: grid; place-items: center; min-height: 100vh; background: #0b0d12; color: #e8eaed }
    .card { width: min(92vw, 820px); background: #11151c; border: 1px solid #2a2f3a; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.35) }
    h1 { margin: 0 0 10px; font-size: 22px; font-weight: 600 }
    .flag-stage { position: relative; width: 640px; max-width: 100%; aspect-ratio: 4/3; margin: 16px auto; background: #0e1218; border-radius: 14px; overflow: hidden; border: 1px solid #2a2f3a }
    .layer { position: absolute; inset: 0; display: none }
    .layer.visible { display: block }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; justify-content: space-between }
    button { background: #2b64ff; color: white; border: none; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer }
    button:disabled { opacity: .55; cursor: not-allowed }
    .pill { padding: 6px 10px; border: 1px solid #2a2f3a; border-radius: 999px; font-size: 12px; opacity: .85 }
    .answer { font-size: 18px; font-weight: 600; letter-spacing: .3px }
    .tiny { font-size: 12px; opacity: .75 }
    .colors { display: flex; gap: 6px; align-items: center; margin-top: 8px }
    .swatch { width: 16px; height: 16px; border-radius: 4px; border: 1px solid #0006 }
    .controls { display: flex; gap: 8px; flex-wrap: wrap }
  </style>
</head>
<body>
  <div class="card">
    <h1>Guess the Flag — Layer Reveal</h1>
    <div class="row">
      <div class="pill" id="progress">– / –</div>
      <div class="colors" id="colors"></div>
    </div>
    <div class="flag-stage" id="stage"></div>
    <div class="row">
      <div class="controls">
        <button id="reveal">Reveal Next Layer</button>
        <button id="guess">Show Answer</button>
        <button id="skip">Skip Flag</button>
        <button id="reset">Restart Layers</button>
      </div>
      <div class="answer" id="answer"> </div>
    </div>
    <div class="tiny" style="margin-top:10px;">Tip: distinctive colors tend to appear first; white/black are shown last.</div>
  </div>

  <script>
    const stage = document.getElementById('stage');
    const answer = document.getElementById('answer');
    const progress = document.getElementById('progress');
    const colorsBox = document.getElementById('colors');
    const btnReveal = document.getElementById('reveal');
    const btnGuess = document.getElementById('guess');
    const btnSkip = document.getElementById('skip');
    const btnReset = document.getElementById('reset');

    let manifest = {};
    let order = [];
    let idx = -1;
    let current = null;
    let visibleCount = 0;

    function isoToName(cc) {
      try {
        return new Intl.DisplayNames(['en'], { type: 'region' }).of(cc.toUpperCase()) || cc.toUpperCase();
      } catch {
        return cc.toUpperCase();
      }
    }

    function clearStage() {
      stage.innerHTML = '';
      colorsBox.innerHTML = '';
      visibleCount = 0;
      answer.textContent = ' ';
      progress.textContent = '– / –';
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function loadFlag(cc) {
      clearStage();
      current = { cc, ...manifest[cc] };
      current.files.forEach((file) => {
        const img = document.createElement('img');
        img.className = 'layer';
        img.decoding = 'async';
        img.loading = 'eager';
        img.src = `/output/${cc}/${file}`;
        stage.appendChild(img);
      });

      current.colors.forEach((hex) => {
        const sw = document.createElement('div');
        sw.className = 'swatch';
        sw.style.background = hex;
        colorsBox.appendChild(sw);
      });

      progress.textContent = `0 / ${current.files.length}`;
      btnReveal.disabled = false;
      btnReset.disabled = false;
      btnGuess.disabled = false;
    }

    function revealLayer() {
      const layers = stage.querySelectorAll('.layer');
      if (visibleCount >= layers.length) {
        btnReveal.disabled = true;
        return;
      }
      layers[visibleCount].classList.add('visible');
      visibleCount++;
      progress.textContent = `${visibleCount} / ${layers.length}`;
      if (visibleCount === layers.length) btnReveal.disabled = true;
    }

    function showAnswer() {
      if (!current) return;
      answer.textContent = isoToName(current.cc);
    }

    function restartLayers() {
      if (!current) return;
      const layers = stage.querySelectorAll('.layer');
      layers.forEach((l) => l.classList.remove('visible'));
      visibleCount = 0;
      progress.textContent = `0 / ${layers.length}`;
      answer.textContent = ' ';
      btnReveal.disabled = false;
    }

    function nextFlag() {
      idx = (idx + 1) % order.length;
      const cc = order[idx];
      loadFlag(cc);
    }

    async function boot() {
      const res = await fetch('/api/manifest');
      manifest = await res.json();
      order = Object.keys(manifest).filter((cc) => (manifest[cc].files || []).length > 0);
      shuffle(order);
      idx = -1;
      nextFlag();
      btnReveal.addEventListener('click', revealLayer);
      btnGuess.addEventListener('click', showAnswer);
      btnSkip.addEventListener('click', () => nextFlag());
      btnReset.addEventListener('click', restartLayers);
    }

    boot();
  </script>
</body>
</html>
